# 学習機能の実装

## 目的

- 現在、MacTcodeはキー入力操作に対してアプリケーションに送信される文字列または変換候補として選択肢となる文字列は決定的である
- これを、過去の操作履歴を反映して決定する手段を追加する。これを学習機能と呼ぶ
- 学習機能によって、ユーザーの過去の決定に近い候補が出力されるようになり、入力作業の省力化が期待できる

## サポート機能

- 学習結果保存機能
    - 学習した結果をファイルに保存し、次回以降のセッションでも再利用できるようにする
    - ファイルの場所はconfig.jsonと同じディレクトリに置く
    - ファイルは通常テキストファイルとする。行単位のプレーンテキストを想定する
    - 学習内容によって複数のファイルを使い分けることもある
- 学習データ
    - 学習データは主として部首変換、交ぜ書き変換の結果に反映される
    - 学習データを利用するためにはメモリ内に一定の構造体・クラスなどの形で保持する
    - 学習データをファイルに対し読み書きするため、シリアライズ形式を定め、シリアライザ/デシリアライザを用意する
    - ユーザーが学習ファイルを編集した場合に検出できるように、最後に学習ファイルと学習データを同期した時刻を記録しておき、学習データを利用しようとした時点で学習ファイルの更新タイムスタンプを見て、最新情報に同期する機構を持つ
- キャンセル期間
    - 部首変換/交ぜ書き変換を確定した際、一定時間キャンセルできるタイミングを設ける
    - キャンセルキーとしてInputEventの.control_g, .escapeを受けつけ、最後に実施した部首変換を元に戻す
    - キャンセルされなかった部首変換結果は「受容された(accepted)」と呼ぶ
    - 次のキー入力があった際に、キャンセル期間内かつキャンセルキーの場合は、キャンセルされたと判定する。キャンセル期間が終了していれば受容されたと見なす
        - キャンセル期間中にIM入力が終了(deactivate)された場合も受容と見なす
    - キャンセル期間の終了は次の入力イベントのタイミングで計算すればよく、タイマースレッドなどで入力なく受容処理を行う必要はない
    - キャンセルキー入力イベントはキャンセル機能を起動して消費される
    - キャンセルキー以外の入力イベントは、キャセル期間を終了し、そのまま次のコマンドまたは基本文字の入力として処理する
    - キャンセル期間の長さは1.5秒をデフォルト値とし、設定ファイルで変更できる

## 自動部首変換機能

- 部首変換で受容された変換結果は、合成元となった2文字と受容された結果を組にして、部首変換学習データとして記録される
- 次回、通常の基本文字入力の処理時、最後に入力した2文字が部首変換学習データに記録されている場合、自動的に部首変換され、合成結果が入力される(自動部首変換機能)
- このときキャンセル期間に入り、キャンセルされた場合は合成元の2文字がアプリケーションに残るように訂正される
- 自動部首変換機能での部首変換学習データとの照合は、合成元の2文字の要素が同じで順序だけ異なる場合でも、不一致と判定する
- 部首変換学習データのシリアライズ形式はbushu.dicと同じ形式とする
    - 1行1エントリ
    - 1行は3文字。合成元部品2文字、合成結果1文字
- 学習データ保存ファイル名はデフォルト値を `bushu_auto.dic` とし、設定可能とする
- 自動部首変換機能を利用するかしないかを設定可能とする(デフォルト値は利用しない)

## 交ぜ書き候補LRU学習

- 交ぜ書き変換で受容された変換結果に対し、どの候補が最終的に選択されたかを学習する
- MazegagiDict.dictではkeyに対応する候補が `/` で連結された文字列として表現されている。この候補順を並びかえ、今回確定された候補が先頭になるようにする
- 学習データとしては、MazegakiHit.keyと候補順文字列の組をdict形式で持つ
    - MazegakiDictで管理するのがよい
- 学習データのシリアライズ形式はmazegaki.dicと同じ形式
    - 1行1エントリ
    - 1行はキーと候補列を空白1文字を区切りとして連結したもの
    - 候補列は、そのキーの変換候補をスラッシュを区切りとして連結したもの
- 学習データ保存ファイル名はデフォルト値を `mazegaki_user.dic` とし、設定可能とする
- 交ぜ書き候補LRU学習を利用するかしないかを設定可能とする(デフォルト値は利用しない)
- 実装ヒント: この学習をサポートするため、MazegakiHitには、dictEntryを保存する

## 設計詳細

### 学習データの競合処理
- 同じ2文字に対して異なる変換結果を学習した場合は、新しいもので上書きする
- 交ぜ書き候補LRU学習で、同じキーに対する異なる学習結果は、新しいもので上書きする

### 学習データの肥大化
- 最大でもbushu.dic, mazegaki.dicの大きさまでしか増えないため、特別な対策は不要

### ファイルI/O
- 書き込みタイミング: 統計データを書き出すタイミングと同じ
- 読み込みタイミング: 起動時(TcodeInputController.init)
- 複数インスタンス: OSレベルで制御されているため、ファイルロック機構は不要

### エラーハンドリング
- ファイル破損時: ログ出力し、破損した状態のファイルを上書きせず保持する
- I/O失敗時: ログ出力のみで処理を継続する（学習機能は無効化されるが、入力機能には影響しない）

### キャンセル期間の詳細
- 連続変換: 後続の変換開始指示入力で先行のキャンセル期間が終了するため、複数のキャンセル履歴を保持する必要はない

